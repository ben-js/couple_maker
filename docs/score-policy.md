# 📊 우선순위 측정 점수 정책 및 매칭 추천 알고리즘

## 🎯 개요
사용자가 작성한 이상형에 맞는 AI 매칭을 위한 Score 알고리즘 정책입니다.

## 🔄 매칭 플로우

### 1. 회원가입 단계
- **회원가입 시**: `users` 테이블에 `has_score: false`로 설정
- **프로필 작성 후**: `has_profile: true`로 업데이트
- **이상형 작성 후**: `has_preferences: true`로 업데이트

### 2. 점수 작성 단계
- **관리자 확인**: Admin 시스템의 회원 관리 페이지에서 `has_score: false`인 고객 확인
- **점수 작성**: 매니저가 고객의 프로필과 사진을 보고 `Scores` 테이블에 점수 작성
- **점수 완료**: `has_score: true`로 업데이트

### 3. 매칭 단계
- **소개팅 신청**: `MatchingRequests`의 `status`가 `waiting`인 유저
- **매칭 추천**: 매칭 알고리즘으로 어울리는 고객 10명 추천
- **매니저 검토**: 추천받은 고객의 점수(radar chart), 프로필, 이상형 확인
- **매칭 승인**: 매니저가 적절한 대상자 선택 후 매칭 승인

## 📈 점수 알고리즘

### 🎨 외모 점수 (100점 만점)
**구성 요소:**
- **얼굴**: 50% (매니저 직접 평가)
- **키**: 20% (성별별 기준)
- **바디타입**: 15% (체형별 기준)
- **나이**: 15% (성별별 기준)

#### 키 점수 기준
**남성 기준:**
- 183~192cm: 100점
- 178~182cm 또는 193~200cm: 90점
- 173~177cm: 80점
- 165~172cm: 70점
- 155~164cm: 60점
- 155cm 미만: 55점

**참고**: 182~193cm 구간은 각각 90점 구간에 포함됨

**여성 기준:**
- 165~168cm: 100점
- 162~164cm 또는 169~172cm: 90점
- 158~161cm 또는 173~175cm: 80점
- 155~157cm 또는 176cm 이상: 70점
- 154cm 미만: 55점

#### 바디타입 점수 기준
- **모델핏**: 100점
- **운동하는체형**: 90점
- **보통/마른**: 85점
- **귀엽고통통한**: 70점
- **통통한편**: 60점
- **포근한체형**: 50점

#### 나이 점수 기준
**계산 기준**: 매칭 신청 시점의 만나이

**남성 기준:**
- 28~31세: 100점
- 25~27세 또는 32~35세: 90점
- 36~38세: 80점
- 25세 미만 또는 39~42세: 70점
- 43세 이상: 60점

**여성 기준:**
- 23~26세: 100점
- 22세 미만 또는 27~29세: 90점
- 30~32세: 80점
- 33~35세: 70점
- 36~39세: 60점
- 40세 이상: 20점

### 😊 성격 점수 (100점 만점)
**구성 요소:**
- **이상형 우선순위**: 10%
- **흡연 유무**: 20%
- **취미**: 35%
- **자녀희망**: 15%
- **MBTI**: 20%

#### 이상형 우선순위 점수
**성격 우선순위:**
- 1순위: 100점
- 2순위: 90점
- 3순위: 80점
- 4순위: 70점
- 5순위: 60점
- 6순위: 50점

**가치관 우선순위:**
- 1순위: 100점
- 2순위: 90점
- 3순위: 80점
- 4순위: 70점
- 5순위: 60점
- 6순위: 50점

**계산 기준**: 
- **기본 가중치**: 성격과 가치관의 가중치는 각각 70%와 30%로 고정
- **사용자 설정**: 사용자가 우선순위 비율을 직접 설정한 경우 해당 비율 적용
- **우선순위**: 사용자 설정이 있는 경우 사용자 설정 우선, 없으면 기본 가중치 적용

**계산 예시:**
성격 1순위 + 가치관 2순위인 경우 (고정 가중치):
- 성격 점수: 100점 × 70% = 70점
- 가치관 점수: 90점 × 30% = 27점
- **총점**: 70점 + 27점 = 97점

#### 흡연 점수
- **비흡연**: 100점
- **흡연**: 50점

#### 취미 점수
**평가 기준**: 가장 높은 점수의 취미 1개만 적용

- **봉사활동**: 100점
- **자기계발/독서/산책** (봉사활동 제외): 90점
- **게임** (봉사활동 제외): 50점
- **기타**: 80점

#### 자녀희망 점수
- **자녀 희망**: 100점
- **딩크족 희망**: 70점

#### MBTI 점수
- **ENFJ**: 100점
- **INFJ**: 95점
- **ESFJ**: 90점
- **ENTP/ENTJ/INTJ**: 70점
- **ISTP/ESTP**: 60점
- **기타**: 80점

### 💼 직업 점수 (100점 만점)
**구성 요소:**
- **직업**: 50%
- **연봉**: 30%
- **직장**: 20% (추후 Company DB 활용 예정)

#### 직업 점수 기준
- **판사/검사**: 100점
- **변호사/의사/교수**: 95점
- **공기업/교사/연예인**: 90점
- **회사원/간호사/운동선수/예술가/작가/미용사**: 80점
- **학생/자영업/요리사**: 70점
- **기타**: 60점

#### 연봉 점수 기준
- **2억원 이상**: 100점
- **1억5천만원~2억원**: 90점
- **7천만원~9천만원**: 85점
- **5천만원~7천만원**: 80점
- **4천만원~5천만원**: 70점
- **4천만원 미만**: 60점

### 🎓 학력 점수 (100점 만점)
- **박사**: 100점
- **대학원**: 90점
- **대학교**: 80점
- **전문대**: 70점
- **고등학교**: 50점

### 💰 경제력 점수 (100점 만점)
**구성 요소:**
- **자산**: 70%
- **직업**: 20%
- **연봉**: 10%

#### 자산 점수 기준
- **20억원 이상**: 100점
- **15억원~20억원**: 95점
- **10억원~15억원**: 90점
- **5억원~10억원**: 85점
- **3억원~5억원**: 80점
- **2억원~3억원**: 75점
- **1억원~2억원**: 75점
- **5천만원~1억원**: 60점
- **5천만원 미만**: 20점

#### 직업 점수 기준
- **판사/검사/변호사/의사**: 100점
- **공기업/교사/교수**: 90점
- **학생**: 60점
- **기타**: 80점

#### 연봉 점수 기준
- **2억원 이상**: 100점
- **1억5천만원~2억원**: 90점
- **7천만원~9천만원**: 85점
- **5천만원~7천만원**: 80점
- **4천만원~5천만원**: 70점
- **4천만원 미만**: 60점

## 🏆 등급 기준

### 점수별 등급 분류
- **S 등급**: 95점 이상
- **A 등급**: 85~94점
- **B 등급**: 75~84점
- **C 등급**: 65~74점
- **D 등급**: 55~64점
- **E 등급**: 45~54점
- **F 등급**: 45점 미만

## 🧮 최종 점수 계산 공식

### 개인 점수 계산
```
개인_총점 = (외모점수 × 0.25) + (성격점수 × 0.25) + (직업점수 × 0.2) + (학력점수 × 0.15) + (경제력점수 × 0.15)
```

### 이상형 매칭도 계산
```
이상형_매칭도 = 우선순위_매칭도
```

### 우선순위 매칭도 계산
신청자가 이상형 작성 시 설정한 우선순위(외모, 직업, 성격, 학력, 경제력)와 상대방의 스코어 등급을 매칭:

**우선순위별 가중치**:
- **1순위**: 40% (가장 중요)
- **2순위**: 30%
- **3순위**: 20%
- **4순위**: 10%

**우선순위별 스코어 등급 매핑**:
- **외모**: appearance 등급
- **직업**: job 등급
- **성격**: personality 등급
- **학력**: education 등급
- **경제력**: economics 등급

**등급별 점수**:
- **S등급**: 100점
- **A등급**: 90점
- **B등급**: 80점
- **C등급**: 60점
- **D등급**: 40점
- **E등급**: 20점
- **F등급**: 10점

## 🔄 점수 조정 시스템

### 리뷰 기반 조정
`Reviews` 테이블의 다음 데이터로 매니저 또는 AI가 점수 조정 가능:
- **tags**: 리뷰 태그
- **rating.honesty**: 솔직함 점수
- **rating.manners**: 매너 점수
- **comment**: 리뷰 코멘트
- **first_impression_vs_reality**: 첫인상 vs 현실 비교

### 점수 조정 방법
- **리뷰 점수**: `(honesty + manners) / 2`
- **조정 범위**: ±10점 이내
- **조정 사유**: 필수 입력 (리뷰 내용 기반)
- **조정 권한**: 매니저 또는 AI (자동 조정)
- **조정 이력**: 모든 조정 내역 기록 및 추적

## 🗄️ 테이블 구조

### Scores 테이블 구조

#### 테이블 스키마
```javascript
{
  TableName: 'Scores',
  KeySchema: [
    { AttributeName: 'user_id', KeyType: 'HASH' }  // Primary Key
  ],
  AttributeDefinitions: [
    { AttributeName: 'user_id', AttributeType: 'S' }
  ]
}
```

### 데이터 구조
```javascript
{
  user_id: 'user_123',           // 사용자 ID
  scorer: 'manager_1',           // 점수 작성한 매니저
  summary: '외모적 능력이 뛰어남', // 총평
  average: 83,                   // 총점 (100점 만점)
  appearance: 'S',               // 외모 등급 (S/A/B/C/D/E/F)
  personality: 'A',              // 성격 등급
  job: 'B',                      // 직업 등급
  education: 'C',                // 학력 등급
  economics: 'D',                // 경제력 등급
  created_at: '2024-12-01T00:00:00Z',
  updated_at: '2024-12-01T00:00:00Z'
}
```

### MatchingRecommendations 테이블 구조

#### 테이블 스키마
```javascript
{
  TableName: 'MatchingRecommendations',
  KeySchema: [
    { AttributeName: 'request_id', KeyType: 'HASH' },  // Primary Key
    { AttributeName: 'recommended_user_id', KeyType: 'RANGE' }  // Sort Key
  ],
  AttributeDefinitions: [
    { AttributeName: 'request_id', AttributeType: 'S' },
    { AttributeName: 'recommended_user_id', AttributeType: 'S' }
  ]
}
```

#### 데이터 구조
```javascript
{
  request_id: 'req_123',              // 매칭 신청 ID
  recommended_user_id: 'user_456',     // 추천된 사용자 ID
  recommendation_count: 1,             // 재추천 횟수 (1~3)
  compatibility_score: 85.5,           // 호환성 점수
  personal_score: 78.2,                // 개인 점수
  final_score: 83.1,                   // 최종 점수
  rank: 3,                             // 추천 순위 (1~10)
  created_at: '2024-12-01T00:00:00Z',
  updated_at: '2024-12-01T00:00:00Z'
}
```

### 점수 산정 예시
- (예시)
  - 외모: 90점, 성격: 80점, 직업: 85점, 학력: 80점, 경제력: 70점
  - 개인 평균점수 = (90×0.25)+(80×0.25)+(85×0.2)+(80×0.15)+(70×0.15) = 22.5+20+17+12+10.5 = 82점 → B등급

---

## 매칭 추천 알고리즘

### 1. 등급별 추천 인원 정책
- 신청자 전체 등급(average) 기준으로
  - 상위 등급 3명: 한 단계 위 등급에서 추출 (VIP/구독은 두 단계 이상 확장)
  - 동일 등급 4명: 동일 등급에서 추출
  - 하위 등급 3명: 한 단계 아래 등급에서 추출
- 등급별 인원이 부족하면 해당 인원만큼만 추천

### 2. 후보군 필터링
- 기본 필터링:
  - has_score: true, Users.status: 'green'/'yellow', is_deleted: false
- 이상형 조건 필터링:
  - 신청자 이상형(나이, 지역, 키, 종교 등) 조건에 맞는 후보만 추림
  - 매칭 상태, 제안 거절 이력, 소개팅/매칭 이력 등 중복/제외 조건 적용

### 3. 재추천 및 조건 완화
- 등급별 인원이 부족할 경우, 재추천 시 조건을 점진적으로 완화
  - 예: 나이/키 범위 확대, 인접 지역/같은 도시 포함 등
  - 완화 조건은 서비스 정책에 따라 유연하게 조정
- 조건을 완화해도 인원이 부족하면 가능한 만큼만 추천
- 최종적으로도 부족하면 매니저에게 “매칭 대상자 부족” 알림

### 4. 등급별 후보군 내 우선순위 및 동점자 처리
- 각 등급별 후보군 내에서는 신청자 이상형 우선순위(외모, 성격, 직업, 학력, 경제력 등)별 가중치로 점수 산정
- 점수가 높은 순서대로 등급별 인원만큼 추출
- 동점자 발생 시, 최근 매칭 이력, 활동성, 가입일 등 추가 기준으로 우선순위 결정

### 5. 매니저 검토 및 제안 생성
- 매니저가 추천 결과(최대 10명)를 보고 직접 제안 생성
- 적절한 대상자가 없으면 재추천 요청 가능(최대 3회)
- 매니저가 최종 선택한 대상자에게 매칭 제안 생성 및 푸시 발송

### 6. 추천 이력 및 통계 관리
- 추천/재추천/제안/매칭 이력은 모두 로그로 남겨 추후 통계 및 운영에 활용
- 추천 결과, 매칭 성공/실패, 재추천 사유 등 데이터화
- 추천/매칭 과정에서 발생한 예외(예: 중복, 블랙리스트 등)도 기록

---

## 등급 산정 및 활용 원칙

- 신청자의 전체 등급은 오직 "개인 점수(average)"로 산정
  - 예: 평균점수 82점 → B등급
- 각 항목별 등급(외모, 성격, 직업, 학력, 경제력 등)은 해당 항목의 점수로 산정
  - 예: 외모 S, 성격 A, 직업 B 등
- 등급별 추천 인원 배분(상위/동일/하위 3/4/3)은 반드시 "개인 평균점수(average)"로 산정된 전체 등급을 기준으로 함
- 이상형 우선순위(외모, 성격 등)별 가중치 계산에는 각 후보의 "항목별 등급"을 활용

#### 예시
- 신청자 평균점수 82점 → B등급 → B등급 기준으로 상위/동일/하위 등급별 후보군 선정
- 신청자가 외모를 1순위로 두었다면, 후보의 "외모 등급"(S/A/B 등)이 최종 점수에 가장 큰 영향
- 즉, 신청자가 B등급이어도 외모 등급이 S인 후보가 추천될 수 있음

---

## 📋 구현 체크리스트 (실무 기준 구분)

### 백엔드에서만 구현하는 것이 일반적인 항목
- Users, Scores, MatchingRecommendations 등 테이블 생성/관리
- 회원가입 시 has_score: false 등 DB 초기값/마이그레이션
- MatchPairs, Proposals 등 매칭/제안 테이블 관리
- 매칭 상태 관리 시스템 (진행/완료/실패 등 상태 전이)
- 매칭 완료 시 추천 데이터 삭제 로직
- 매칭 만료 자동 처리 (유령 매칭/방치 방지 등)
- 데이터 정합성/보안/일관성이 중요한 로직

### 어드민(프론트)에서 구현해도 되는 항목
- 점수 미작성 사용자 목록 표시
- 점수 작성/수정 페이지 및 UI
- Radar Chart 등 점수 시각화
- 매칭 추천 시스템 실행/결과 표시
- 추천 결과 테이블/카드 UI
- 재추천 요청 기능(조건 완화 등)
- 수동 매칭 기능(추천 리스트 중 직접 선택)
- 자동 매칭 기능(1명 자동 선택)
- 임의 매칭 기능(신청하지 않은 유저에게도 매칭)
- 매칭 상태 관리 페이지(진행/완료/실패 등 시각화)
- 점수 조정 이력 관리 UI
- 점수 계산 알고리즘
- 매칭 추천/호환성 점수 계산
- 점수 조정 시스템
- 이상형 매칭 로직
---