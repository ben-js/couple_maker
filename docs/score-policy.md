# 📊 우선순위 측정 점수 정책 및 매칭 추천 알고리즘

## 🎯 개요
사용자가 작성한 이상형에 맞는 AI 매칭을 위한 Score 알고리즘 정책입니다.

## 🔄 매칭 플로우

### 1. 회원가입 단계
- **회원가입 시**: `users` 테이블에 `has_score: false`로 설정
- **프로필 작성 후**: `has_profile: true`로 업데이트
- **이상형 작성 후**: `has_preferences: true`로 업데이트

### 2. 점수 작성 단계
- **관리자 확인**: Admin 시스템의 회원 관리 페이지에서 `has_score: false`인 고객 확인
- **점수 작성**: 매니저가 고객의 프로필과 사진을 보고 `Scores` 테이블에 점수 작성
- **점수 완료**: `has_score: true`로 업데이트

### 3. 매칭 단계
- **소개팅 신청**: `MatchingRequests`의 `status`가 `waiting`인 유저
- **매칭 추천**: 매칭 알고리즘으로 어울리는 고객 10명 추천
- **매니저 검토**: 추천받은 고객의 점수(radar chart), 프로필, 이상형 확인
- **매칭 승인**: 매니저가 적절한 대상자 선택 후 매칭 승인

## 📈 점수 알고리즘

### 🎨 외모 점수 (100점 만점)
**구성 요소:**
- **얼굴**: 50% (매니저 직접 평가)
- **키**: 20% (성별별 기준)
- **바디타입**: 15% (체형별 기준)
- **나이**: 15% (성별별 기준)

#### 키 점수 기준
**남성 기준:**
- 183~192cm: 100점
- 178~182cm 또는 193~200cm: 90점
- 173~177cm: 80점
- 165~172cm: 70점
- 155~164cm: 60점
- 155cm 미만: 55점

**참고**: 182~193cm 구간은 각각 90점 구간에 포함됨

**여성 기준:**
- 165~168cm: 100점
- 162~164cm 또는 169~172cm: 90점
- 158~161cm 또는 173~175cm: 80점
- 155~157cm 또는 176cm 이상: 70점
- 154cm 미만: 55점

#### 바디타입 점수 기준
- **모델핏**: 100점
- **운동하는체형**: 90점
- **보통/마른**: 85점
- **귀엽고통통한**: 70점
- **통통한편**: 60점
- **포근한체형**: 50점

#### 나이 점수 기준
**계산 기준**: 매칭 신청 시점의 만나이

**남성 기준:**
- 28~31세: 100점
- 25~27세 또는 32~35세: 90점
- 36~38세: 80점
- 25세 미만 또는 39~42세: 70점
- 43세 이상: 60점

**여성 기준:**
- 23~26세: 100점
- 22세 미만 또는 27~29세: 90점
- 30~32세: 80점
- 33~35세: 70점
- 36~39세: 60점
- 40세 이상: 20점

### 😊 성격 점수 (100점 만점)
**구성 요소:**
- **이상형 우선순위**: 10%
- **흡연 유무**: 20%
- **취미**: 35%
- **자녀희망**: 15%
- **MBTI**: 20%

#### 이상형 우선순위 점수
**성격 우선순위:**
- 1순위: 100점
- 2순위: 90점
- 3순위: 80점
- 4순위: 70점
- 5순위: 60점
- 6순위: 50점

**가치관 우선순위:**
- 1순위: 100점
- 2순위: 90점
- 3순위: 80점
- 4순위: 70점
- 5순위: 60점
- 6순위: 50점

**계산 기준**: 
- **기본 가중치**: 성격과 가치관의 가중치는 각각 70%와 30%로 고정
- **사용자 설정**: 사용자가 우선순위 비율을 직접 설정한 경우 해당 비율 적용
- **우선순위**: 사용자 설정이 있는 경우 사용자 설정 우선, 없으면 기본 가중치 적용

**계산 예시:**
성격 1순위 + 가치관 2순위인 경우 (고정 가중치):
- 성격 점수: 100점 × 70% = 70점
- 가치관 점수: 90점 × 30% = 27점
- **총점**: 70점 + 27점 = 97점

#### 흡연 점수
- **비흡연**: 100점
- **흡연**: 50점

#### 취미 점수
**평가 기준**: 가장 높은 점수의 취미 1개만 적용

- **봉사활동**: 100점
- **자기계발/독서/산책** (봉사활동 제외): 90점
- **게임** (봉사활동 제외): 50점
- **기타**: 80점

#### 자녀희망 점수
- **자녀 희망**: 100점
- **딩크족 희망**: 70점

#### MBTI 점수
- **ENFJ**: 100점
- **INFJ**: 95점
- **ESFJ**: 90점
- **ENTP/ENTJ/INTJ**: 70점
- **ISTP/ESTP**: 60점
- **기타**: 80점

### 💼 직업 점수 (100점 만점)
**구성 요소:**
- **직업**: 50%
- **연봉**: 30%
- **직장**: 20% (추후 Company DB 활용 예정)

#### 직업 점수 기준
- **판사/검사**: 100점
- **변호사/의사/교수**: 95점
- **공기업/교사/연예인**: 90점
- **회사원/간호사/운동선수/예술가/작가/미용사**: 80점
- **학생/자영업/요리사**: 70점
- **기타**: 60점

#### 연봉 점수 기준
- **2억원 이상**: 100점
- **1억5천만원~2억원**: 90점
- **7천만원~9천만원**: 85점
- **5천만원~7천만원**: 80점
- **4천만원~5천만원**: 70점
- **4천만원 미만**: 60점

### 🎓 학력 점수 (100점 만점)
- **박사**: 100점
- **대학원**: 90점
- **대학교**: 80점
- **전문대**: 70점
- **고등학교**: 50점

### 💰 경제력 점수 (100점 만점)
**구성 요소:**
- **자산**: 70%
- **직업**: 20%
- **연봉**: 10%

#### 자산 점수 기준
- **20억원 이상**: 100점
- **15억원~20억원**: 95점
- **10억원~15억원**: 90점
- **5억원~10억원**: 85점
- **3억원~5억원**: 80점
- **2억원~3억원**: 75점
- **1억원~2억원**: 75점
- **5천만원~1억원**: 60점
- **5천만원 미만**: 20점

#### 직업 점수 기준
- **판사/검사/변호사/의사**: 100점
- **공기업/교사/교수**: 90점
- **학생**: 60점
- **기타**: 80점

#### 연봉 점수 기준
- **2억원 이상**: 100점
- **1억5천만원~2억원**: 90점
- **7천만원~9천만원**: 85점
- **5천만원~7천만원**: 80점
- **4천만원~5천만원**: 70점
- **4천만원 미만**: 60점

## 🏆 등급 기준

### 점수별 등급 분류
- **S 등급**: 95점 이상
- **A 등급**: 85~94점
- **B 등급**: 75~84점
- **C 등급**: 65~74점
- **D 등급**: 55~64점
- **E 등급**: 45~54점
- **F 등급**: 45점 미만

## 🧮 최종 점수 계산 공식

### 개인 점수 계산
```
개인_총점 = (외모점수 × 0.25) + (성격점수 × 0.25) + (직업점수 × 0.2) + (학력점수 × 0.15) + (경제력점수 × 0.15)
```

### 이상형 매칭도 계산
```
이상형_매칭도 = 우선순위_매칭도
```

### 우선순위 매칭도 계산
신청자가 이상형 작성 시 설정한 우선순위(외모, 직업, 성격, 학력, 경제력)와 상대방의 스코어 등급을 매칭:

**우선순위별 가중치**:
- **1순위**: 40% (가장 중요)
- **2순위**: 30%
- **3순위**: 20%
- **4순위**: 10%

**우선순위별 스코어 등급 매핑**:
- **외모**: appearance 등급
- **직업**: job 등급
- **성격**: personality 등급
- **학력**: education 등급
- **경제력**: economics 등급

**등급별 점수**:
- **S등급**: 100점
- **A등급**: 90점
- **B등급**: 80점
- **C등급**: 60점
- **D등급**: 40점
- **E등급**: 20점
- **F등급**: 10점

### 우선순위 매칭도 계산 예시
**신청자 A의 이상형 우선순위**:
- 1순위: 외모
- 2순위: 경제력
- 3순위: 성격
- 4순위: 직업

**대상자 B의 스코어 등급**:
- appearance: 'A'등급
- economics: 'S'등급
- personality: 'B'등급
- job: 'C'등급

**우선순위별 스코어 매칭도 계산**:
- 1순위 매칭도: 외모(A등급) = 90점 × 0.4 = 36점
- 2순위 매칭도: 경제력(S등급) = 100점 × 0.3 = 30점
- 3순위 매칭도: 성격(B등급) = 80점 × 0.2 = 16점
- 4순위 매칭도: 직업(C등급) = 60점 × 0.1 = 6점

**우선순위_매칭도 = 36 + 30 + 16 + 6 = 88점**

### 호환성 점수 계산
```
호환성_점수 = (이상형_매칭도 × 0.8) + (상호_관심도 × 0.2)
```

### 상호 관심도 계산
**양방향 매칭 판단 기준**:
- 신청자 A의 이상형 조건에 대상자 B가 부합하는지 확인
- 대상자 B의 이상형 조건에 신청자 A가 부합하는지 확인

**점수 기준**:
- **양방향 매칭** (100점): A→B 부합 AND B→A 부합
- **단방향 매칭** (60점): A→B 부합 OR B→A 부합 (둘 중 하나만)
- **무관심** (20점): A→B 불부합 AND B→A 불부합

### 최종 매칭 점수 계산
```
최종_점수 = (호환성_점수 × 0.7) + (개인_점수 × 0.3)
```

## 🏆 매칭 우선순위 기준

### 우선순위 결정 요소
1. **호환성 점수** (70%): 양방향 이상형 매칭도
2. **개인 점수** (30%): 매니저 평가 점수
3. **추가 보너스**: 
   - VIP 등급: +10점
   - 프리미엄 회원: +5점
   - 신규 회원 (1개월 이내): +3점

### 매칭 상태 관리 (MatchingRequests.status)
- **waiting**: 소개팅 신청 완료, 매칭 대기 중
- **matched**: 매칭 성사, 일정/장소 선택 대기
- **mismatched**: 일정/장소가 맞지 않음, 재선택 필요
- **confirmed**: 일정/장소 확정, 관리자 최종 확인 대기
- **scheduled**: 소개팅 일정 확정, 사진 공개 대기
- **review**: 소개팅 완료, 후기 작성 대기
- **completed**: 후기 작성 완료, 연락처 교환 가능
- **exchanged**: 연락처 교환 완료
- **finished**: 소개팅 종료, 연락처 삭제됨
- **failed**: 매칭 실패, 포인트 반환

### 매칭 제외 조건
- `status: 'black'`인 사용자 (블랙 상태 회원 제외)
- `is_deleted: true`인 사용자
- 이미 매칭 신청한 사용자 (`MatchingRequests.status: 'waiting'`)
- `has_score: false`인 사용자
- 매칭 신청 만료된 사용자 (`MatchingRequests.status: 'failed'`)
- `Proposals` 테이블에서 거절 이력이 있는 사용자

### 이상형 조건 제외
- **나이 불일치**: 신청자의 이상형 나이 범위에 포함되지 않는 사용자
- **지역 불일치**: 신청자의 이상형 지역과 맞지 않는 사용자
- **키 불일치**: 신청자의 이상형 키 범위에 포함되지 않는 사용자
- **종교 불일치**: 신청자의 이상형 종교와 맞지 않는 사용자

## 🔄 점수 조정 시스템

### 리뷰 기반 조정
`Reviews` 테이블의 다음 데이터로 매니저 또는 AI가 점수 조정 가능:
- **tags**: 리뷰 태그
- **rating.honesty**: 솔직함 점수
- **rating.manners**: 매너 점수
- **comment**: 리뷰 코멘트
- **first_impression_vs_reality**: 첫인상 vs 현실 비교

### 점수 조정 방법
- **리뷰 점수**: `(honesty + manners) / 2`
- **조정 범위**: ±10점 이내
- **조정 사유**: 필수 입력 (리뷰 내용 기반)
- **조정 권한**: 매니저 또는 AI (자동 조정)
- **조정 이력**: 모든 조정 내역 기록 및 추적



## 🗄️ 테이블 구조

### Scores 테이블 구조

#### 테이블 스키마
```javascript
{
  TableName: 'Scores',
  KeySchema: [
    { AttributeName: 'user_id', KeyType: 'HASH' }  // Primary Key
  ],
  AttributeDefinitions: [
    { AttributeName: 'user_id', AttributeType: 'S' }
  ]
}
```

### 데이터 구조
```javascript
{
  user_id: 'user_123',           // 사용자 ID
  scorer: 'manager_1',           // 점수 작성한 매니저
  summary: '외모적 능력이 뛰어남', // 총평
  average: 83,                   // 총점 (100점 만점)
  appearance: 'S',               // 외모 등급 (S/A/B/C/D/E/F)
  personality: 'A',              // 성격 등급
  job: 'B',                      // 직업 등급
  education: 'C',                // 학력 등급
  economics: 'D',                // 경제력 등급
  created_at: '2024-12-01T00:00:00Z',
  updated_at: '2024-12-01T00:00:00Z'
}
```

### MatchingRecommendations 테이블 구조

#### 테이블 스키마
```javascript
{
  TableName: 'MatchingRecommendations',
  KeySchema: [
    { AttributeName: 'request_id', KeyType: 'HASH' },  // Primary Key
    { AttributeName: 'recommended_user_id', KeyType: 'RANGE' }  // Sort Key
  ],
  AttributeDefinitions: [
    { AttributeName: 'request_id', AttributeType: 'S' },
    { AttributeName: 'recommended_user_id', AttributeType: 'S' }
  ]
}
```

#### 데이터 구조
```javascript
{
  request_id: 'req_123',              // 매칭 신청 ID
  recommended_user_id: 'user_456',     // 추천된 사용자 ID
  recommendation_count: 1,             // 재추천 횟수 (1~3)
  compatibility_score: 85.5,           // 호환성 점수
  personal_score: 78.2,                // 개인 점수
  final_score: 83.1,                   // 최종 점수
  rank: 3,                             // 추천 순위 (1~10)
  status: 'pending',                   // 상태: pending/rejected
  created_at: '2024-12-01T00:00:00Z',
  updated_at: '2024-12-01T00:00:00Z'
}
```



## 🎯 매칭 추천 알고리즘

### 1단계: 기본 필터링
- `has_score: true`인 사용자만 대상
- `Users.status`가 `'green'` 또는 `'yellow'`인 사용자만 대상 (`'red'`, `'black'` 제외)
- `is_deleted: false`인 사용자만 대상

### 1-1단계: 이상형 조건 필터링
- **나이 조건**: 신청자의 이상형 나이 범위에 포함되지 않는 사용자 제외
- **지역 조건**: 신청자의 이상형 지역과 맞지 않는 사용자 제외
- **키 조건**: 신청자의 이상형 키 범위에 포함되지 않는 사용자 제외
- **종교 조건**: 신청자의 이상형 종교와 맞지 않는 사용자 제외
- **매칭 상태 조건**: `MatchingRequests.status`가 `'waiting'`이 아닌 사용자 제외 (이미 매칭 진행 중)
- **제안 거절 이력**: `Proposals` 테이블에서 `status: 'refuse'`인 사용자 제외
- **소개팅 이력**: `MatchingHistory` 테이블에서 이미 소개팅한 사용자 제외
- **매칭 이력**: `MatchPairs` 테이블에서 `match_b_id`로 이미 매칭된 사용자 제외


**예외 처리**:
- **매칭 대상자 부족** (10명 미만): 이상형 조건을 점진적으로 완화
  - **1차**: 정확 일치 (신청자 이상형 조건 그대로)
  - **2차**: 조건 완화
    - 나이: ±2세 범위 확대
    - 키: ±3cm 범위 확대
    - 지역: 인접 지역 포함
  - **3차**: 조건 더 완화
    - 나이: ±5세 범위 확대
    - 키: ±5cm 범위 확대
    - 지역: 같은 도시(시/도) 내 모든 지역 포함
- **여전히 부족**: 매니저에게 "매칭 대상자 부족" 알림

**지역 확대 로직**:
- **인접 지역**: 같은 시/도 내에서 신청자 지역과 인접한 구/군
- **같은 도시**: 신청자와 같은 시/도 내 모든 구/군
- **예시**: 신청자가 "서울 강남"인 경우
  - 1차: "서울 강남"만
  - 2차: "서울 강남, 서초, 송파, 성동" (인접 구)
  - 3차: "서울 전체" (모든 구)

### 2단계: 이상형 매칭도 계산
- 신청자의 우선순위(외모, 직업, 성격, 학력, 경제력)와 대상자의 스코어 등급 매칭
- 우선순위별 가중치 적용 (1순위: 40%, 2순위: 30%, 3순위: 20%, 4순위: 10%)
- 등급별 점수 매핑 (S: 100점, A: 90점, B: 80점, C: 60점, D: 40점, E: 20점, F: 10점)

### 3단계: 호환성 점수 계산
- 이상형_매칭도(80%) + 상호_관심도(20%)
- 양방향 매칭도 계산 (신청자→대상자, 대상자→신청자)
- 상호 관심도: 양방향 매칭(100점), 단방향 매칭(60점), 무관심(20점)

### 4단계: 최종 순위 결정
- 호환성 점수 + 개인 점수 가중 평균
- VIP 등급, 프리미엄 회원 등 추가 보너스 적용
- 상위 10명 추천

### 5단계: 추천 결과 저장 및 표시
- 추천된 10명의 정보를 `MatchingRecommendations` 테이블에 저장
- 추천된 10명의 정보를 매니저에게 표시
- 추천 결과에 대한 매니저 검토 대기

### 6단계: 매니저 검토 및 제안 생성
- **매니저 검토**: 추천된 10명 중 적절한 매칭 대상자 선택
- **적절한 대상자 없음**: 매니저가 "재추천 요청" 버튼 클릭
- **재추천 프로세스**: 
  - 기존 추천 대상자들의 `status`를 `'rejected'`로 변경
  - **2차, 3차 재추천 시 이상형 조건 재확인**:
    - 나이 조건 불일치 사용자 제외 (2차: ±2세, 3차: ±5세 범위 확대)
    - 지역 조건 불일치 사용자 제외 (2차: 인접 지역, 3차: 같은 도시)
    - 키 조건 불일치 사용자 제외 (2차: ±3cm, 3차: ±5cm 범위 확대)
    - 종교 조건 불일치 사용자 제외
    - 매칭 상태 조건: `MatchingRequests.status`가 `'waiting'`이 아닌 사용자 제외
    - 제안 거절 이력: `Proposals` 테이블에서 `status: 'refuse'`인 사용자 제외
    - 소개팅 이력: `MatchingHistory` 테이블에서 이미 소개팅한 사용자 제외
    - 매칭 이력: `MatchPairs` 테이블에서 `match_b_id`로 이미 매칭된 사용자 제외

  - 새로운 10명 추천 시 `status: 'rejected'`인 사용자 제외
  - `recommendation_count` 필드로 재추천 횟수 추적 (최대 3회)
  - 3회 재추천 후에도 적절한 대상자가 없으면 `status: 'failed'`로 설정하고 포인트 반환
- **매칭 제안**: 매니저가 적절한 대상자 선택 후 제안 생성
  - `Proposals` 테이블에 제안 생성 (상태: 'pending')
  - `MatchingRequests` 상태는 `waiting` 유지
  - 선택된 대상자에게 "소개팅 제안 도착" 푸시 발송
- **매칭 일정 확정 시**: `MatchingRequests.status`가 `'scheduled'`로 변경될 때 `MatchingRecommendations`에서 해당 `request_id`의 모든 추천 데이터 삭제

## 📋 구현 체크리스트

### 백엔드 구현
- [ ] `Users` 테이블에 `has_score` 필드 추가
- [ ] 회원가입 시 `has_score: false` 설정
- [ ] `Scores` 테이블 생성
- [ ] 점수 계산 알고리즘 구현
- [ ] 매칭 추천 API 구현
- [ ] 이상형 매칭 로직 구현
- [ ] 호환성 점수 계산 함수 구현
- [ ] `MatchingRecommendations` 테이블 생성
- [ ] `MatchPairs` 테이블 활용
- [ ] `Proposals` 테이블 활용
- [ ] 매칭 상태 관리 시스템 구현
- [ ] 매칭 완료 시 추천 데이터 삭제 로직 구현
- [ ] 점수 조정 시스템 구현

### Admin 시스템 구현
- [ ] 점수 미작성 사용자 목록 표시
- [ ] 점수 작성 페이지 구현
- [ ] Radar Chart 점수 시각화
- [ ] 매칭 추천 시스템 구현
- [ ] 매칭 추천 결과 표시 (등급 높은 순으로 10명)
- [ ] 재추천 요청 기능 (최대 3회)
- [ ] 수동 매칭 기능 (10명 중 선택)
- [ ] 자동 매칭 기능 (AI 추천 기반 1명 자동 선택)
- [ ] 임의 매칭 기능 (신청하지 않은 유저에게도 매칭 가능)
- [ ] 매칭 상태 관리 페이지
- [ ] 점수 조정 이력 관리
- [ ] 매칭 만료 자동 처리


